<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="FreelanHub - Plateforme d'emploi et de freelancing" />
    <title>FreelanHub - Liste des Candidats</title>
    <link rel="shortcut icon" href="./assets/images/fav.png" type="image/x-icon" />
    <link rel="stylesheet" href="./assets/css/swiper-bundle.min.css" />
    <link rel="stylesheet" href="./assets/css/leaflet.css" />
    <link rel="stylesheet" href="./assets/css/slick.css" />
    <link rel="stylesheet" href="./assets/css/style.css" />
    <link rel="stylesheet" href="./dist/output-tailwind.css" />
    <link rel="stylesheet" href="./dist/output-scss.css" />
    <style>
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .alert-error {
            background-color: #fee2e2;
            color: #b91c1c;
        }
        .alert-success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header id="header" class="header -style-white relative">
        <div class="header_inner absolute flex items-center justify-between top-0 left-0 right-0 z-[1] w-full sm:h-20 h-16 min-[1600px]:px-15 lg:px-9 px-4 border-b border-light">
            <div class="left flex items-center gap-15 h-full max-[1600px]:gap-6">
                <h1>
                    <a href="index.html">
                        <img src="./assets/images/logo-white.png" alt="logo-white" class="logo-white md:h-[42px] h-8 w-auto" />
                        <img src="./assets/images/logo.png" alt="logo" class="logo-black md:h-[42px] h-8 w-auto hidden" />
                    </a>
                </h1>
            </div>
            <div class="navigator h-full max-[1400px]:hidden">
                <ul class="list flex items-center gap-5 h-full">
                    <li class="h-full">
                        <a href="index.html" class="flex items-center gap-1 h-full text-white duration-300">
                            <span class="text-title relative">Accueil</span>
                        </a>
                    </li>
                    <li class="h-full relative group">
                        <a href="#!" class="flex items-center gap-1 h-full text-white duration-300">
                            <span class="text-title relative">Candidats</span>
                            <span class="ph-bold ph-caret-down"></span>
                        </a>
                        <div class="sub_menu absolute hidden group-hover:block p-3 -left-10 w-max bg-white rounded-lg">
                            <ul>
                                <li>
                                    <a href="jobs-default.html" class="link block text-button py-[11px] px-6 rounded duration-300 hover:bg-gray-100">Offres d'emploi</a>
                                </li>
                                <li>
                                    <a href="project-default.html" class="link block text-button py-[11px] px-6 rounded duration-300 hover:bg-gray-100">Projets disponibles</a>
                                </li>
                                <li>
                                    <a href="employers-default.html" class="link block text-button py-[11px] px-6 rounded duration-300 hover:bg-gray-100">Employeurs</a>
                                </li>
                                <li>
                                    <a href="become-seller.html" class="link block text-button py-[11px] px-6 rounded duration-300 hover:bg-gray-100">Devenir vendeur</a>
                                </li>
                                <li>
                                    <a href="candidates-dashboard.html" class="link block text-button py-[11px] px-6 rounded duration-300 hover:bg-gray-100">Tableau de bord</a>
                                </li>
                            </ul>
                        </div>
                    </li>
                    <li class="h-full relative group">
                        <a href="#!" class="flex items-center gap-1 h-full text-white duration-300">
                            <span class="text-title relative">Employeurs</span>
                            <span class="ph-bold ph-caret-down"></span>
                        </a>
                        <div class="sub_menu absolute hidden group-hover:block p-3 -left-10 w-max bg-white rounded-lg">
                            <ul>
                                <li>
                                    <a href="services-default.html" class="link block text-button py-[11px] px-6 rounded duration-300 hover:bg-gray-100">Services</a>
                                </li>
                                <li>
                                    <a href="candidates-default.html" class="link block text-button py-[11px] px-6 rounded duration-300 hover:bg-gray-100">Candidats</a>
                                </li>
                                <li>
                                    <a href="become-buyer.html" class="link block text-button py-[11px] px-6 rounded duration-300 hover:bg-gray-100">Devenir acheteur</a>
                                </li>
                                <li>
                                    <a href="employers-dashboard.html" class="link block text-button py-[11px] px-6 rounded duration-300 hover:bg-gray-100">Tableau de bord</a>
                                </li>
                            </ul>
                        </div>
                    </li>
                    <li class="h-full relative group">
                        <a href="#!" class="flex items-center gap-1 h-full text-white duration-300 active">
                            <span class="text-title relative">Autres pages</span>
                            <span class="ph-bold ph-caret-down"></span>
                        </a>
                        <div class="sub_menu absolute hidden group-hover:block p-3 -left-10 w-max bg-white rounded-lg">
                            <ul>
                                <li>
                                    <a href="about.html" class="link block text-button py-[11px] px-6 rounded duration-300 hover:bg-gray-100">À propos</a>
                                </li>
                                <li>
                                    <a href="pricing.html" class="link block text-button py-[11px] px-6 rounded duration-300 hover:bg-gray-100">Tarifs</a>
                                </li>
                                <li>
                                    <a href="contact.html" class="link block text-button py-[11px] px-6 rounded duration-300 hover:bg-gray-100">Contact</a>
                                </li>
                                <li>
                                    <a href="faqs.html" class="link block text-button py-[11px] px-6 rounded duration-300 hover:bg-gray-100">FAQ</a>
                                </li>
                                <li>
                                    <a href="term-of-use.html" class="link block text-button py-[11px] px-6 rounded duration-300 hover:bg-gray-100">Conditions</a>
                                </li>
                                <li>
                                    <a href="login.html" class="link block text-button py-[11px] px-6 rounded duration-300 hover:bg-gray-100 active">Connexion</a>
                                </li>
                                <li>
                                    <a href="register.html" class="link block text-button py-[11px] px-6 rounded duration-300 hover:bg-gray-100">Inscription</a>
                                </li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </div>
            <div class="list_action flex items-center gap-5">
                <a href="become-seller.html" class="button-main bg-white text-black max-sm:hidden">Devenir vendeur</a>
                <div class="user_block relative max-sm:hidden group">
                    <button class="user_infor flex items-center gap-2 text-white">
                        <img src="./assets/images/avatar/IMG-7.webp" alt="Profil" class="user_avatar flex-shrink-0 w-9 h-9 rounded-full" />
                        <strong class="user_name text-title">Employeur</strong>
                        <span class="ph ph-caret-down"></span>
                    </button>
                    <ul class="list_action_user absolute hidden group-hover:block w-[240px] p-3 top-14 right-0 bg-white rounded-lg">
                        <li class="action_item">
                            <a href="employers-dashboard.html" class="link flex items-center gap-3 w-full py-3 px-6 rounded-lg duration-300 hover:bg-gray-100">
                                <span class="ph ph-squares-four text-2xl text-secondary"></span>
                                <strong class="text-title">Tableau de bord</strong>
                            </a>
                        </li>
                        <li class="action_item">
                            <a href="employers-profile.html" class="link flex items-center gap-3 w-full py-3 px-6 rounded-lg duration-300 hover:bg-gray-100">
                                <span class="ph ph-user-circle text-2xl text-secondary"></span>
                                <strong class="text-title">Mon profil</strong>
                            </a>
                        </li>
                        <li class="action_item">
                            <a href="login.html" class="link flex items-center gap-3 w-full py-3 px-6 rounded-lg duration-300 hover:bg-gray-100">
                                <span class="ph ph-sign-out text-2xl text-secondary"></span>
                                <strong class="text-title">Déconnexion</strong>
                            </a>
                        </li>
                    </ul>
                </div>
                <button class="humburger_btn min-[1400px]:hidden">
                    <span class="ph-bold ph-list text-white text-2xl block"></span>
                </button>
            </div>
        </div>
    </header>

    <!-- Fil d'Ariane corrigé -->
    <section class="breadcrumb">
        <div class="breadcrumb_inner relative sm:mt-20 mt-16 lg:py-20 py-14">
            <div class="breadcrumb_bg absolute top-0 left-0 w-full h-full">
                <img src="./assets/images/components/breadcrumb_candidate.webp" alt="Arrière-plan" class="w-full h-full object-cover" />
            </div>
            <div class="container relative h-full">
                <div class="breadcrumb_content flex flex-col items-start justify-center xl:w-[1000px] lg:w-[848px] md:w-5/6 w-full h-full">
                    <div class="list_breadcrumb flex items-center gap-2 animate animate_top" style="--i: 1">
                        <a href="index.html" class="caption1 text-white">Accueil</a>
                        <span class="caption1 text-white opacity-40">/</span>
                        <span class="caption1 text-white">Candidats</span>
                    </div>
                    <h3 class="heading3 text-white mt-2 animate animate_top" style="--i: 2">Trouvez les meilleurs talents</h3>
                </div>
            </div>
        </div>
    </section>

    <!-- Liste des candidats -->
    <div class="candidates lg:py-20 sm:py-14 py-10">
        <div class="container flex flex-col items-center">
            <!-- Filtres -->
            <div class="filter flex flex-wrap items-center justify-between gap-8 gap-y-3 relative w-full">
                <button id="filter_btn" class="filter_btn inline-flex items-center gap-1.5 py-1.5 px-2.5 border border-line rounded-md duration-300 hover:bg-primary hover:text-white">
                    <span class="ph ph-sliders-horizontal text-xl"></span>
                    <span>Filters</span>
                </button>
                
                <div class="select_filter flex items-center gap-3">
                    <span class="caption1">Trier par:</span>
                    <div class="select_block sm:pr-16 pr-10 pl-3 py-1 border border-line rounded">
                        <select id="sort-select" class="caption1 capitalize bg-transparent border-none focus:outline-none">
                            <option value="default">Par défaut</option>
                            <option value="rating-desc">Note (décroissant)</option>
                            <option value="rating-asc">Note (croissant)</option>
                            <option value="rate-desc">Taux horaire (décroissant)</option>
                            <option value="rate-asc">Taux horaire (croissant)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Barre de recherche -->
            <div class="form_search z-[1] w-full mt-5">
                <form id="search-form" class="form_inner flex items-center justify-between max-sm:flex-wrap gap-6 gap-y-4 relative w-full p-3 rounded-lg bg-white">
                    <div class="form_input relative w-full">
                        <span class="icon_search ph-bold ph-magnifying-glass absolute top-1/2 -translate-y-1/2 left-2 text-xl"></span>
                        <input type="text" id="search-input" class="input_search w-full h-full pl-10" placeholder="Nom, compétence ou localisation" />
                    </div>
                    <button type="submit" class="button-main max-sm:w-1/3 text-center flex-shrink-0">Rechercher</button>
                </form>
            </div>

            <!-- Messages d'erreur -->
            <div id="error-message" class="hidden"></div>

            <!-- Liste des candidats -->
            <ul class="list_layout_cols list_candidates grid md:grid-cols-2 lg:gap-7.5 gap-5 w-full md:mt-10 mt-7" id="candidates-list">
                <!-- Chargement dynamique -->
            </ul>

            <!-- Pagination -->
            <div class="pagination-controls flex items-center justify-center gap-4 mt-8">
                <button id="prev-page" class="pagination-btn disabled:opacity-50" disabled>
                    <span class="ph ph-caret-left"></span> Précédent
                </button>
                <span id="page-info" class="text-sm">Page 1</span>
                <button id="next-page" class="pagination-btn disabled:opacity-50">
                    Suivant <span class="ph ph-caret-right"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Bouton de retour en haut -->
    <button class="scroll-to-top-btn"><span class="ph-bold ph-caret-up"></span></button>

    <!-- Menu mobile -->
    <div class="menu_mobile hidden">
        <button class="menu_mobile_close flex items-center justify-center absolute top-5 left-5 w-8 h-8 rounded-full bg-surface">
            <span class="ph-bold ph-x"></span>
        </button>
        <div class="heading flex items-center justify-center mt-5">
            <a href="index.html" class="logo">
                <img src="./assets/images/logo.png" alt="FreelanHub" class="h-8" />
            </a>
        </div>
        <div class="mt-4">
            <ul class="nav_mobile">
                <li class="nav_item py-2">
                    <a href="index.html" class="text-xl font-semibold">Accueil</a>
                </li>
                <li class="nav_item py-2">
                    <a href="#!" class="text-xl font-semibold flex items-center justify-between toggle-submenu">
                        Candidats
                        <span class="text-right">
                            <i class="ph ph-caret-right text-xl"></i>
                        </span>
                    </a>
                    <div class="sub_nav_mobile hidden">
                        <button class="back_btn flex items-center gap-3">
                            <i class="ph ph-caret-left text-xl"></i>
                            Retour
                        </button>
                        <div class="list-nav-item w-full pt-2 pb-6">
                            <ul>
                                <li class="nav_item">
                                    <a href="jobs-default.html" class="block py-2">Offres d'emploi</a>
                                </li>
                                <li class="nav_item">
                                    <a href="project-default.html" class="block py-2">Projets disponibles</a>
                                </li>
                                <li class="nav_item">
                                    <a href="employers-default.html" class="block py-2">Employeurs</a>
                                </li>
                                <li class="nav_item">
                                    <a href="become-seller.html" class="block py-2">Devenir vendeur</a>
                                </li>
                                <li class="nav_item">
                                    <a href="candidates-dashboard.html" class="block py-2">Tableau de bord</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </li>
                <li class="nav_item py-2">
                    <a href="#!" class="text-xl font-semibold flex items-center justify-between toggle-submenu">
                        Employeurs
                        <span class="text-right">
                            <i class="ph ph-caret-right text-xl"></i>
                        </span>
                    </a>
                    <div class="sub_nav_mobile hidden">
                        <button class="back_btn flex items-center gap-3">
                            <i class="ph ph-caret-left text-xl"></i>
                            Retour
                        </button>
                        <div class="list-nav-item w-full pt-2 pb-6">
                            <ul>
                                <li class="nav_item">
                                    <a href="services-default.html" class="block py-2">Services</a>
                                </li>
                                <li class="nav_item">
                                    <a href="candidates-default.html" class="block py-2">Candidats</a>
                                </li>
                                <li class="nav_item">
                                    <a href="become-buyer.html" class="block py-2">Devenir acheteur</a>
                                </li>
                                <li class="nav_item">
                                    <a href="employers-dashboard.html" class="block py-2">Tableau de bord</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </li>
                <li class="nav_item py-2">
                    <a href="#!" class="text-xl font-semibold flex items-center justify-between toggle-submenu">
                        Autres pages
                        <span class="text-right">
                            <i class="ph ph-caret-right text-xl"></i>
                        </span>
                    </a>
                    <div class="sub_nav_mobile hidden">
                        <button class="back_btn flex items-center gap-3">
                            <i class="ph ph-caret-left text-xl"></i>
                            Retour
                        </button>
                        <div class="list-nav-item w-full pt-2 pb-6">
                            <ul>
                                <li class="nav_item">
                                    <a href="about.html" class="block py-2">À propos</a>
                                </li>
                                <li class="nav_item">
                                    <a href="pricing.html" class="block py-2">Tarifs</a>
                                </li>
                                <li class="nav_item">
                                    <a href="contact.html" class="block py-2">Contact</a>
                                </li>
                                <li class="nav_item">
                                    <a href="faqs.html" class="block py-2">FAQ</a>
                                </li>
                                <li class="nav_item">
                                    <a href="term-of-use.html" class="block py-2">Conditions</a>
                                </li>
                                <li class="nav_item">
                                    <a href="login.html" class="block py-2">Connexion</a>
                                </li>
                                <li class="nav_item">
                                    <a href="register.html" class="block py-2">Inscription</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="./assets/js/jquery.min.js"></script>
    <script src="./assets/js/phosphor-icons.js"></script>
    <script src="./assets/js/slick.min.js"></script>
    <script src="./assets/js/leaflet.js"></script>
    <script src="./assets/js/swiper-bundle.min.js"></script>
    <script src="./assets/js/main.js"></script>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAmr9Nar3YdKuphgu-HW-qYeShhTk07C2c",
            authDomain: "hob-app-3530d.firebaseapp.com",
            projectId: "hob-app-3530d",
            storageBucket: "hob-app-3530d.appspot.com",
            messagingSenderId: "207981400350",
            appId: "1:207981400350:web:15badcca0bb9808f96790f"
        };

        // Initialisation Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Variables globales
        let currentUser = null;
        let currentUserData = null;
        let candidates = [];
        let filteredCandidates = [];
        let currentPage = 1;
        const candidatesPerPage = 8;

        // Fonctions utilitaires
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.innerHTML = `
                <div class="alert alert-error">
                    <span class="ph ph-warning-circle"></span>
                    ${message}
                </div>
            `;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        function showSuccess(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.innerHTML = `
                <div class="alert alert-success">
                    <span class="ph ph-check-circle"></span>
                    ${message}
                </div>
            `;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        function renderLoading() {
            const list = document.getElementById('candidates-list');
            list.innerHTML = `
                <li class="col-span-2 flex flex-col items-center justify-center py-10">
                    <span class="ph ph-spinner loading-spinner text-4xl mb-4"></span>
                    <p>Chargement des candidats...</p>
                </li>
            `;
        }

        function renderCandidates(candidatesToRender) {
            const list = document.getElementById('candidates-list');
            
            if (candidatesToRender.length === 0) {
                list.innerHTML = `
                    <li class="col-span-2 text-center py-10">
                        <span class="ph ph-magnifying-glass text-4xl mb-4"></span>
                        <p>Aucun candidat ne correspond à votre recherche</p>
                    </li>
                `;
                return;
            }

            list.innerHTML = '';

            candidatesToRender.forEach(candidate => {
                const isFavorite = currentUserData?.favorites?.includes(candidate.id) || false;
                
                const candidateElement = `
                    <li class="candidates_item px-6 py-5 rounded-lg bg-white shadow-md duration-300 hover:shadow-xl">
                        <div class="candidates_info flex gap-4 relative w-full pb-4 border-b border-line">
                            <a href="candidates-detail.html?id=${candidate.id}" class="overflow-hidden flex-shrink-0 w-15 h-15 rounded-full">
                                <img src="${candidate.photoURL || './assets/images/avatar/IMG-1.webp'}" 
                                     alt="${candidate.firstName} ${candidate.lastName}" 
                                     class="candidates_avatar w-full h-full object-cover" />
                            </a>
                            <div class="candidates_content w-full">
                                <a href="candidates-detail.html?id=${candidate.id}" class="candidates_detail flex flex-col gap-1 mr-14 duration-300 hover:text-primary">
                                    <strong class="candidates_name -style-1 w-fit text-title">${candidate.firstName} ${candidate.lastName}</strong>
                                    <span class="flex items-center text-secondary">
                                        <span class="ph ph-map-pin text-lg"></span>
                                        <span class="candidates_address -style-1 caption1 pl-1">
                                            ${candidate.city}, ${candidate.country}
                                        </span>
                                    </span>
                                </a>
                                <div class="flex flex-wrap items-center justify-between gap-4 mt-1">
                                    <div class="flex flex-wrap items-center gap-3">
                                        <strong class="candidates_status tag caption2 bg-background text-primary">
                                            ${candidate.available ? 'Disponible' : 'Indisponible'}
                                        </strong>
                                        <div class="flex items-center gap-1">
                                            <span class="ph-fill ph-star text-yellow text-sm"></span>
                                            <strong class="candidates_rate text-sm font-semibold">${candidate.rating?.toFixed(1) || 'N/A'}</strong>
                                            <span class="candidates_rate_quantity caption1 text-secondary">
                                                (${candidate.reviews || '0'} avis)
                                            </span>
                                        </div>
                                    </div>
                                    <a href="candidates-detail.html?id=${candidate.id}" class="button-main -border">
                                        Voir le profil
                                    </a>
                                </div>
                            </div>
                            ${currentUserData?.userType === 'employer' ? `
                            <button class="add_wishlist_btn absolute top-0 right-0 -border ${isFavorite ? 'active' : ''}" 
                                    data-candidate-id="${candidate.id}">
                                <span class="ph ph-heart text-xl ${isFavorite ? 'hidden' : ''}"></span>
                                <span class="ph-fill ph-heart text-xl ${isFavorite ? '' : 'hidden'}"></span>
                            </button>
                            ` : ''}
                        </div>
                        <div class="candidates_more_info flex flex-wrap items-center justify-between gap-3 pt-4">
                            <div class="flex flex-wrap items-center gap-2.5">
                                ${candidate.skills?.slice(0, 3).map(skill => `
                                    <span class="candidates_tag caption1 tag bg-surface">${skill}</span>
                                `).join('')}
                                ${candidate.skills?.length > 3 ? `
                                    <span class="candidates_tag caption1 tag bg-surface">+${candidate.skills.length - 3}</span>
                                ` : ''}
                            </div>
                            <div class="candidates_price">
                                <span class="price text-title">${candidate.hourlyRate || 'N/A'}</span>
                                <span class="text-secondary">/heure</span>
                            </div>
                        </div>
                    </li>
                `;
                list.insertAdjacentHTML('beforeend', candidateElement);
            });

            // Gestion des favoris
            document.querySelectorAll('.add_wishlist_btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    if (!currentUser) {
                        showError('Connectez-vous pour ajouter aux favoris');
                        return;
                    }

                    const candidateId = this.getAttribute('data-candidate-id');
                    const userRef = db.collection('users').doc(currentUser.uid);
                    
                    try {
                        // Récupérer les favoris actuels
                        const userDoc = await userRef.get();
                        let favorites = userDoc.data().favorites || [];
                        
                        if (this.classList.contains('active')) {
                            // Retirer des favoris
                            favorites = favorites.filter(id => id !== candidateId);
                            await userRef.update({
                                favorites: favorites,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            this.classList.remove('active');
                            this.querySelector('.ph').classList.remove('hidden');
                            this.querySelector('.ph-fill').classList.add('hidden');
                            showSuccess('Candidat retiré des favoris');
                        } else {
                            // Ajouter aux favoris
                            favorites.push(candidateId);
                            await userRef.update({
                                favorites: favorites,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            this.classList.add('active');
                            this.querySelector('.ph').classList.add('hidden');
                            this.querySelector('.ph-fill').classList.remove('hidden');
                            showSuccess('Candidat ajouté aux favoris');
                        }
                    } catch (error) {
                        console.error("Erreur favoris:", error);
                        showError('Erreur lors de la mise à jour des favoris');
                    }
                });
            });
        }

        function filterAndSortCandidates() {
            const searchInput = document.getElementById('search-input').value.toLowerCase();
            const sortSelect = document.getElementById('sort-select').value;

            // Filtrage
            filteredCandidates = candidates.filter(candidate => {
                const matchesSearch = 
                    `${candidate.firstName} ${candidate.lastName}`.toLowerCase().includes(searchInput) ||
                    (candidate.skills && candidate.skills.some(skill => skill.toLowerCase().includes(searchInput))) ||
                    `${candidate.city}, ${candidate.country}`.toLowerCase().includes(searchInput);
                
                return matchesSearch;
            });

            // Tri
            switch(sortSelect) {
                case 'rating-desc':
                    filteredCandidates.sort((a, b) => (b.rating || 0) - (a.rating || 0));
                    break;
                case 'rating-asc':
                    filteredCandidates.sort((a, b) => (a.rating || 0) - (b.rating || 0));
                    break;
                case 'rate-desc':
                    filteredCandidates.sort((a, b) => (b.hourlyRate || 0) - (a.hourlyRate || 0));
                    break;
                case 'rate-asc':
                    filteredCandidates.sort((a, b) => (a.hourlyRate || 0) - (b.hourlyRate || 0));
                    break;
                default:
                    // Tri par défaut (date de création)
                    filteredCandidates.sort((a, b) => {
                        const dateA = a.createdAt?.toDate() || new Date(0);
                        const dateB = b.createdAt?.toDate() || new Date(0);
                        return dateB - dateA;
                    });
            }

            currentPage = 1;
            updatePagination();
            renderCurrentPage();
        }

        function renderCurrentPage() {
            const startIndex = (currentPage - 1) * candidatesPerPage;
            const endIndex = startIndex + candidatesPerPage;
            const candidatesToRender = filteredCandidates.slice(startIndex, endIndex);
            renderCandidates(candidatesToRender);
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredCandidates.length / candidatesPerPage);
            document.getElementById('page-info').textContent = `Page ${currentPage} sur ${totalPages || 1}`;
            
            document.getElementById('prev-page').disabled = currentPage <= 1;
            document.getElementById('next-page').disabled = currentPage >= totalPages || totalPages === 0;
        }

        // Événements
        document.getElementById('search-form').addEventListener('submit', (e) => {
            e.preventDefault();
            filterAndSortCandidates();
        });

        document.getElementById('search-input').addEventListener('input', () => {
            filterAndSortCandidates();
        });

        document.getElementById('sort-select').addEventListener('change', () => {
            filterAndSortCandidates();
        });

        document.getElementById('prev-page').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderCurrentPage();
                updatePagination();
            }
        });

        document.getElementById('next-page').addEventListener('click', () => {
            const totalPages = Math.ceil(filteredCandidates.length / candidatesPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderCurrentPage();
                updatePagination();
            }
        });

        // Initialisation
        document.addEventListener('DOMContentLoaded', async () => {
            renderLoading();

            // Vérifier l'authentification
            auth.onAuthStateChanged(async (user) => {
                currentUser = user;
                
                if (user) {
                    // Charger les données de l'utilisateur
                    try {
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        if (userDoc.exists) {
                            currentUserData = userDoc.data();
                            
                            // Mettre à jour l'UI
                            const userBlock = document.querySelector('.user_block');
                            if (userBlock) {
                                userBlock.style.display = 'block';
                                const userNameElement = document.querySelector('.user_name');
                                if (userNameElement) {
                                    userNameElement.textContent = currentUserData.firstName || 'Utilisateur';
                                }
                            }
                        }
                    } catch (error) {
                        console.error("Erreur chargement utilisateur:", error);
                    }
                } else {
                    // Cacher le bloc utilisateur si non connecté
                    const userBlock = document.querySelector('.user_block');
                    if (userBlock) {
                        userBlock.style.display = 'none';
                    }
                }

                // Charger les candidats
                try {
                    const querySnapshot = await db.collection('users')
                        .where('userType', '==', 'candidate')
                        .get();

                    candidates = querySnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                    filteredCandidates = [...candidates];
                    filterAndSortCandidates();
                } catch (error) {
                    console.error("Erreur chargement candidats:", error);
                    showError('Erreur lors du chargement des candidats');
                    renderLoading();
                }
            });
        });

        // Gestion du menu mobile
        const humburgerBtn = document.querySelector('.humburger_btn');
        const menuMobile = document.querySelector('.menu_mobile');
        const menuMobileClose = document.querySelector('.menu_mobile_close');
        
        if (humburgerBtn) humburgerBtn.addEventListener('click', function() {
            menuMobile.classList.remove('hidden');
        });
        
        if (menuMobileClose) menuMobileClose.addEventListener('click', function() {
            menuMobile.classList.add('hidden');
        });
        
        // Gestion des sous-menus mobiles
        document.querySelectorAll('.toggle-submenu').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                this.nextElementSibling.classList.toggle('hidden');
            });
        });
        
        document.querySelectorAll('.back_btn').forEach(btn => {
            btn.addEventListener('click', function() {
                this.parentElement.classList.add('hidden');
            });
        });
    </script>
</body>
</html>